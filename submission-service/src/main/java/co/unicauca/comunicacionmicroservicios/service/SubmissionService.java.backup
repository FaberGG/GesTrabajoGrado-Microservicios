package co.unicauca.comunicacionmicroservicios.service;

import co.unicauca.comunicacionmicroservicios.domain.model.ProyectoSubmission;
import co.unicauca.comunicacionmicroservicios.domain.model.ProyectoGrado;
import co.unicauca.comunicacionmicroservicios.domain.model.Anteproyecto;
import co.unicauca.comunicacionmicroservicios.domain.model.enumEstadoProyecto;
import co.unicauca.comunicacionmicroservicios.dto.*;
import co.unicauca.comunicacionmicroservicios.dto.events.AnteproyectoEnviadoEvent;
import co.unicauca.comunicacionmicroservicios.dto.events.FormatoAEnviadoEvent;
import co.unicauca.comunicacionmicroservicios.dto.events.FormatoAReenviadoEvent;
import co.unicauca.comunicacionmicroservicios.infrastructure.persistence.SubmissionRepository;
import co.unicauca.comunicacionmicroservicios.infraestructure.repository.IProyectoGradoRepository;
import co.unicauca.comunicacionmicroservicios.infraestructure.repository.IAnteproyectoRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.server.ResponseStatusException;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

/**
 * Servicio para gestionar las submissions con patrÃ³n State
 */
@Service
@Transactional
public class SubmissionService implements ISubmissionService {

    private static final Logger log = LoggerFactory.getLogger(SubmissionService.class);

    @Autowired
    private SubmissionRepository submissionRepository;

    @Autowired
    private IProyectoGradoRepository proyectoGradoRepository;

    @Autowired
    private IAnteproyectoRepository anteproyectoRepository;

    @Autowired
    private ProgressEventPublisher progressEventPublisher;

    @Autowired
    private NotificationPublisher notificationPublisher;


    @Autowired
    private IdentityClient identityClient;

    /**
     * Crear un nuevo proyecto submission (estado inicial: FORMATO_A_DILIGENCIADO)
     */
    public SubmissionResponseDTO crearSubmission(CreateSubmissionDTO dto) {
        ProyectoSubmission proyecto = new ProyectoSubmission();

        // Mapear datos del DTO a la entidad
        proyecto.setTitulo(dto.getTitulo());
        proyecto.setDescripcion(dto.getDescripcion());
        proyecto.setModalidad(dto.getModalidad());
        proyecto.setDocenteDirectorId(dto.getDocenteDirectorId());
        proyecto.setDocenteCodirectorId(dto.getDocenteCodirectorId());
        proyecto.setEstudianteId(dto.getEstudianteId());
        proyecto.setObjetivoGeneral(dto.getObjetivoGeneral());
        proyecto.setObjetivosEspecificos(dto.getObjetivosEspecificos());
        proyecto.setRutaFormatoA(dto.getRutaFormatoA());
        proyecto.setRutaCarta(dto.getRutaCarta());

        // El constructor ya inicializa el estado en FORMATO_A_DILIGENCIADO
        ProyectoSubmission guardado = submissionRepository.save(proyecto);

        System.out.println("âœ… Nuevo proyecto creado con ID: " + guardado.getId() +
                         " en estado: " + guardado.getEstadoNombre());

        return convertirADTO(guardado);
    }

    /**
     * Presentar el formato A al coordinador
     * TransiciÃ³n: FORMATO_A_DILIGENCIADO -> PRESENTADO_AL_COORDINADOR
     */
    public SubmissionResponseDTO presentarAlCoordinador(Long id) {
        ProyectoSubmission proyecto = obtenerProyectoPorId(id);

        // Delegar al patrÃ³n State
        proyecto.presentarAlCoordinador();

        ProyectoSubmission actualizado = submissionRepository.save(proyecto);
        System.out.println("ðŸ“¤ Proyecto " + id + " presentado al coordinador");

        return convertirADTO(actualizado);
    }

    /**
     * Enviar el formato A al comitÃ© para evaluaciÃ³n
     * TransiciÃ³n: PRESENTADO_AL_COORDINADOR -> EN_EVALUACION_COMITE
     */
    public SubmissionResponseDTO enviarAComite(Long id) {
        ProyectoSubmission proyecto = obtenerProyectoPorId(id);

        // Delegar al patrÃ³n State
        proyecto.enviarAComite();

        ProyectoSubmission actualizado = submissionRepository.save(proyecto);
        System.out.println("ðŸ“¨ Proyecto " + id + " enviado al comitÃ© para evaluaciÃ³n");

        return convertirADTO(actualizado);
    }

    /**
     * Evaluar el formato A (aprobar o rechazar)
     * Transiciones posibles desde EN_EVALUACION_COMITE:
     * - Si aprueba -> ACEPTADO_POR_COMITE
     * - Si rechaza y intentos < 3 -> CORRECCIONES_COMITE
     * - Si rechaza y intentos >= 3 -> RECHAZADO_POR_COMITE
     */
    public SubmissionResponseDTO evaluar(Long id, EvaluacionDTO evaluacion) {
        ProyectoSubmission proyecto = obtenerProyectoPorId(id);

        // Delegar al patrÃ³n State
        proyecto.evaluar(evaluacion.getAprobado(), evaluacion.getComentarios());

        ProyectoSubmission actualizado = submissionRepository.save(proyecto);

        if (evaluacion.getAprobado()) {
            System.out.println("âœ… Proyecto " + id + " APROBADO por el comitÃ©");
        } else {
            System.out.println("âŒ Proyecto " + id + " RECHAZADO (Intento " +
                             actualizado.getNumeroIntentos() + "/3)");
        }

        return convertirADTO(actualizado);
    }

    /**
     * Subir una nueva versiÃ³n del formato A tras correcciones
     * TransiciÃ³n: CORRECCIONES_COMITE -> EN_EVALUACION_COMITE
     */
    public SubmissionResponseDTO subirNuevaVersion(Long id) {
        ProyectoSubmission proyecto = obtenerProyectoPorId(id);

        // Delegar al patrÃ³n State
        proyecto.subirNuevaVersion();

        ProyectoSubmission actualizado = submissionRepository.save(proyecto);
        System.out.println("ðŸ”„ Proyecto " + id + " - Nueva versiÃ³n subida, reenviando al comitÃ©");

        return convertirADTO(actualizado);
    }

    /**
     * Obtener un proyecto por ID
     */
    @Transactional(readOnly = true)
    public SubmissionResponseDTO obtenerSubmission(Long id) {
        ProyectoSubmission proyecto = obtenerProyectoPorId(id);
        return convertirADTO(proyecto);
    }

    /**
     * Listar todos los proyectos
     */
    @Transactional(readOnly = true)
    public List<SubmissionResponseDTO> listarTodos() {
        return submissionRepository.findAll()
                .stream()
                .map(this::convertirADTO)
                .collect(Collectors.toList());
    }

    /**
     * Listar proyectos por estado
     */
    @Transactional(readOnly = true)
    public List<SubmissionResponseDTO> listarPorEstado(String estado) {
        return submissionRepository.findByEstadoNombre(estado)
                .stream()
                .map(this::convertirADTO)
                .collect(Collectors.toList());
    }

    /**
     * Listar proyectos por docente
     */
    @Transactional(readOnly = true)
    public List<SubmissionResponseDTO> listarPorDocente(Long docenteId) {
        return submissionRepository.findByDocenteDirectorId(docenteId)
                .stream()
                .map(this::convertirADTO)
                .collect(Collectors.toList());
    }

    /**
     * Listar proyectos en proceso (no finalizados)
     */
    @Transactional(readOnly = true)
    public List<SubmissionResponseDTO> listarEnProceso() {
        return submissionRepository.findProyectosEnProceso()
                .stream()
                .map(this::convertirADTO)
                .collect(Collectors.toList());
    }

    // MÃ©todos auxiliares privados

    private ProyectoSubmission obtenerProyectoPorId(Long id) {
        return submissionRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Proyecto no encontrado con ID: " + id));
    }

    private SubmissionResponseDTO convertirADTO(ProyectoSubmission proyecto) {
        SubmissionResponseDTO dto = new SubmissionResponseDTO();

        dto.setId(proyecto.getId());
        dto.setTitulo(proyecto.getTitulo());
        dto.setDescripcion(proyecto.getDescripcion());
        dto.setModalidad(proyecto.getModalidad());
        dto.setFechaCreacion(proyecto.getFechaCreacion());
        dto.setFechaUltimaModificacion(proyecto.getFechaUltimaModificacion());

        dto.setDocenteDirectorId(proyecto.getDocenteDirectorId());
        dto.setDocenteCodirectorId(proyecto.getDocenteCodirectorId());
        dto.setEstudiante1Id(proyecto.getEstudiante1Id());
        dto.setEstudiante2Id(proyecto.getEstudiante2Id());

        dto.setObjetivoGeneral(proyecto.getObjetivoGeneral());
        dto.setObjetivosEspecificos(proyecto.getObjetivosEspecificos());

        dto.setEstadoActual(proyecto.getEstadoNombre());
        dto.setNumeroIntentos(proyecto.getNumeroIntentos());
        dto.setComentariosComite(proyecto.getComentariosComite());
        dto.setEsEstadoFinal(proyecto.esEstadoFinal());

        dto.setRutaFormatoA(proyecto.getRutaFormatoA());
        dto.setRutaCarta(proyecto.getRutaCarta());

        return dto;
    }

    // ImplementaciÃ³n de mÃ©todos de ISubmissionService

    @Override
    public IdResponse crearFormatoA(String userId, FormatoAData data, MultipartFile pdf, MultipartFile carta) {
        log.info("ðŸ“ Creando Formato A inicial - Usuario: {}, TÃ­tulo: {}", userId, data.getTitulo());

        // 1. Validar archivos
        if (pdf == null || pdf.isEmpty()) {
            throw new IllegalArgumentException("El PDF del Formato A es obligatorio");
        }

        if (data.getModalidad() == co.unicauca.comunicacionmicroservicios.domain.model.enumModalidad.PRACTICA_PROFESIONAL) {
            if (carta == null || carta.isEmpty()) {
                throw new IllegalArgumentException("La carta es obligatoria para modalidad PRACTICA_PROFESIONAL");
            }
        }

        // 2. Guardar archivos (TEMPORAL - delegar a FileStorageService si existe)
        String rutaPdf = "/uploads/formatoA/" + pdf.getOriginalFilename();
        String rutaCarta = carta != null ? "/uploads/cartas/" + carta.getOriginalFilename() : null;

        // 3. Crear proyecto
        ProyectoSubmission proyecto = new ProyectoSubmission();
        proyecto.setTitulo(data.getTitulo());
        proyecto.setModalidad(data.getModalidad());
        proyecto.setObjetivoGeneral(data.getObjetivoGeneral());
        proyecto.setObjetivosEspecificos(String.join("; ", data.getObjetivosEspecificos()));
        proyecto.setDocenteDirectorId(Long.valueOf(data.getDirectorId()));
        proyecto.setDocenteCodirectorId(data.getCodirectorId() != null ? Long.valueOf(data.getCodirectorId()) : null);
        proyecto.setEstudiante1Id(Long.valueOf(data.getEstudiante1Id()));
        proyecto.setEstudiante2Id(data.getEstudiante2Id() != null ? Long.valueOf(data.getEstudiante2Id()) : null);
        proyecto.setRutaFormatoA(rutaPdf);
        proyecto.setRutaCarta(rutaCarta);
        proyecto.setNumeroIntentos(1); // Primera versiÃ³n

        // 4. Guardar en BD
        ProyectoSubmission guardado = submissionRepository.save(proyecto);
        log.info("âœ… Proyecto creado con ID: {}", guardado.getId());

        // 5. Obtener informaciÃ³n del usuario responsable desde Identity Service
        IdentityClient.UserBasicInfo userInfo = identityClient.getUserById(Long.valueOf(userId));
        log.info("âœ… Usuario responsable obtenido: {}", userInfo != null ? userInfo.getNombreCompleto() : "DESCONOCIDO");

        // 6. Obtener informaciÃ³n completa del director
        IdentityClient.UserBasicInfo directorInfo = identityClient.getUserById(Long.valueOf(data.getDirectorId()));
        String directorNombre = directorInfo != null ? directorInfo.getNombreCompleto() : "Director Desconocido";
        log.info("âœ… Director obtenido: {}", directorNombre);

        // 7. Obtener informaciÃ³n del codirector (si existe)
        String codirectorNombre = null;
        if (data.getCodirectorId() != null) {
            IdentityClient.UserBasicInfo codirectorInfo = identityClient.getUserById(Long.valueOf(data.getCodirectorId()));
            codirectorNombre = codirectorInfo != null ? codirectorInfo.getNombreCompleto() : "Codirector Desconocido";
            log.info("âœ… Codirector obtenido: {}", codirectorNombre);
        }

        // 8. Obtener informaciÃ³n completa del estudiante 1 (incluyendo programa)
        IdentityClient.UserBasicInfo estudiante1Info = identityClient.getUserById(Long.valueOf(data.getEstudiante1Id()));
        String estudiante1Nombre = estudiante1Info != null ? estudiante1Info.getNombreCompleto() : "Estudiante Desconocido";
        String programa = "DESCONOCIDO";
        if (estudiante1Info != null && estudiante1Info.programa() != null) {
            programa = estudiante1Info.programa();
            log.info("âœ… Estudiante 1 obtenido: {} - Programa: {}", estudiante1Nombre, programa);
        } else {
            log.warn("âš ï¸ No se pudo obtener el programa del estudiante {}, usando valor por defecto", data.getEstudiante1Id());
        }

        // 9. Obtener informaciÃ³n del estudiante 2 (si existe)
        String estudiante2Nombre = null;
        if (data.getEstudiante2Id() != null) {
            IdentityClient.UserBasicInfo estudiante2Info = identityClient.getUserById(Long.valueOf(data.getEstudiante2Id()));
            estudiante2Nombre = estudiante2Info != null ? estudiante2Info.getNombreCompleto() : "Estudiante 2 Desconocido";
            log.info("âœ… Estudiante 2 obtenido: {}", estudiante2Nombre);
        }

        // 10. Publicar evento a Progress Tracking con TODOS los campos
        FormatoAEnviadoEvent event = FormatoAEnviadoEvent.builder()
                .proyectoId(guardado.getId())
                .titulo(guardado.getTitulo())
                .modalidad(guardado.getModalidad().name())
                .programa(programa)
                .version(1)
                .descripcion("Primera versiÃ³n del Formato A")
                .timestamp(LocalDateTime.now())
                .usuarioResponsableId(Long.valueOf(userId))
                .usuarioResponsableNombre(userInfo != null ? userInfo.getNombreCompleto() : "DESCONOCIDO")
                .usuarioResponsableRol("DOCENTE")
                // âœ¨ NUEVOS CAMPOS - InformaciÃ³n completa del proyecto
                .directorId(Long.valueOf(data.getDirectorId()))
                .directorNombre(directorNombre)
                .codirectorId(data.getCodirectorId() != null ? Long.valueOf(data.getCodirectorId()) : null)
                .codirectorNombre(codirectorNombre)
                .estudiante1Id(Long.valueOf(data.getEstudiante1Id()))
                .estudiante1Nombre(estudiante1Nombre)
                .estudiante2Id(data.getEstudiante2Id() != null ? Long.valueOf(data.getEstudiante2Id()) : null)
                .estudiante2Nombre(estudiante2Nombre)
                .build();

        log.info("ðŸ“¤ Publicando evento FormatoAEnviado para proyecto: {}", guardado.getId());
        progressEventPublisher.publicarFormatoAEnviado(event);
        log.info("âœ… Evento FormatoAEnviado publicado exitosamente");

        // 11. Obtener email del coordinador y enviar notificaciÃ³n (RF2)
        try {
            String coordinadorEmail = identityClient.getCoordinadorEmail();
            notificationPublisher.notificarFormatoAEnviado(
                    guardado.getId().intValue(),
                    guardado.getTitulo(),
                    1, // versiÃ³n 1
                    userInfo != null ? userInfo.getNombreCompleto() : "DESCONOCIDO",
                    coordinadorEmail
            );
            log.info("âœ‰ï¸ RF2: NotificaciÃ³n enviada al coordinador: {}", coordinadorEmail);
        } catch (Exception e) {
            log.error("âŒ RF2: Error al enviar notificaciÃ³n, pero el Formato A fue creado exitosamente", e);
            // No fallar la operaciÃ³n principal por error en notificaciÃ³n
        }

        // 12. Retornar respuesta
        return new IdResponse(guardado.getId());
    }

    @Override
    public FormatoAView obtenerFormatoA(Long id) {
        // TODO: Implementar lÃ³gica completa
        throw new UnsupportedOperationException("MÃ©todo obtenerFormatoA aÃºn no implementado");
    }

    @Override
    public FormatoAPage listarFormatoA(Optional<String> docenteId, int page, int size) {
        // TODO: Implementar lÃ³gica completa
        throw new UnsupportedOperationException("MÃ©todo listarFormatoA aÃºn no implementado");
    }

    @Override
    public IdResponse reenviarFormatoA(String userId, Long proyectoId, MultipartFile pdf, MultipartFile carta) {
        log.info("ðŸ”„ Reenviando Formato A - Proyecto: {}, Usuario: {}", proyectoId, userId);

        // 1. Validar que el proyecto existe
        ProyectoSubmission proyecto = submissionRepository.findById(proyectoId)
                .orElseThrow(() -> new IllegalArgumentException("Proyecto no encontrado: " + proyectoId));

        // 2. Validar que el usuario es el director
        if (!proyecto.getDocenteDirectorId().equals(Long.valueOf(userId))) {
            throw new IllegalArgumentException("Solo el director del proyecto puede reenviar el Formato A");
        }

        // 3. Validar que no estÃ¡ rechazado definitivamente
        if ("RECHAZADO_POR_COMITE".equals(proyecto.getEstadoNombre())) {
            throw new IllegalArgumentException("El proyecto fue rechazado definitivamente, no se puede reenviar");
        }

        // 4. Validar que no excede 3 intentos
        if (proyecto.getNumeroIntentos() >= 3) {
            throw new IllegalArgumentException("Se alcanzÃ³ el mÃ¡ximo de intentos (3)");
        }

        // 5. Validar archivos
        if (pdf == null || pdf.isEmpty()) {
            throw new IllegalArgumentException("El PDF del Formato A es obligatorio");
        }

        // 6. Guardar nuevos archivos
        String rutaPdf = "/uploads/formatoA/v" + (proyecto.getNumeroIntentos() + 1) + "_" + pdf.getOriginalFilename();
        String rutaCarta = carta != null ? "/uploads/cartas/v" + (proyecto.getNumeroIntentos() + 1) + "_" + carta.getOriginalFilename() : null;

        // 7. Actualizar proyecto
        proyecto.setRutaFormatoA(rutaPdf);
        if (rutaCarta != null) {
            proyecto.setRutaCarta(rutaCarta);
        }
        proyecto.setNumeroIntentos(proyecto.getNumeroIntentos() + 1);
        proyecto.setFechaUltimaModificacion(LocalDateTime.now());

        // 8. Guardar en BD
        ProyectoSubmission actualizado = submissionRepository.save(proyecto);
        log.info("âœ… Formato A reenviado - Intento: {}/3", actualizado.getNumeroIntentos());

        // 9. Obtener informaciÃ³n del usuario responsable
        IdentityClient.UserBasicInfo userInfo = identityClient.getUserById(Long.valueOf(userId));
        log.info("âœ… Usuario responsable obtenido: {}", userInfo != null ? userInfo.getNombreCompleto() : "DESCONOCIDO");

        // 10. Obtener informaciÃ³n completa del director
        IdentityClient.UserBasicInfo directorInfo = identityClient.getUserById(actualizado.getDocenteDirectorId());
        String directorNombre = directorInfo != null ? directorInfo.getNombreCompleto() : "Director Desconocido";

        // 11. Obtener informaciÃ³n del codirector (si existe)
        String codirectorNombre = null;
        if (actualizado.getDocenteCodirectorId() != null) {
            IdentityClient.UserBasicInfo codirectorInfo = identityClient.getUserById(actualizado.getDocenteCodirectorId());
            codirectorNombre = codirectorInfo != null ? codirectorInfo.getNombreCompleto() : "Codirector Desconocido";
        }

        // 12. Obtener informaciÃ³n completa del estudiante 1 (incluyendo programa)
        IdentityClient.UserBasicInfo estudiante1Info = identityClient.getUserById(actualizado.getEstudianteId());
        String estudiante1Nombre = estudiante1Info != null ? estudiante1Info.getNombreCompleto() : "Estudiante Desconocido";
        String programa = "DESCONOCIDO";
        if (estudiante1Info != null && estudiante1Info.programa() != null) {
            programa = estudiante1Info.programa();
        }

        // 13. Verificar si hay segundo estudiante (el modelo actual solo tiene estudianteId, no estudiante2Id)
        // Por ahora dejamos estos campos como null hasta que el modelo se actualice
        String estudiante2Nombre = null;
        Long estudiante2Id = null;

        // 14. Publicar evento a Progress Tracking con informaciÃ³n completa
        FormatoAReenviadoEvent event = FormatoAReenviadoEvent.builder()
                .proyectoId(actualizado.getId())
                .titulo(actualizado.getTitulo())
                .modalidad(actualizado.getModalidad().name())
                .programa(programa)
                .version(actualizado.getNumeroIntentos())
                .descripcion("Correcciones aplicadas - versiÃ³n " + actualizado.getNumeroIntentos())
                .timestamp(LocalDateTime.now())
                .usuarioResponsableId(Long.valueOf(userId))
                .usuarioResponsableNombre(userInfo != null ? userInfo.getNombreCompleto() : "DESCONOCIDO")
                .usuarioResponsableRol("DOCENTE")
                // âœ¨ InformaciÃ³n completa del proyecto
                .directorId(actualizado.getDocenteDirectorId())
                .directorNombre(directorNombre)
                .codirectorId(actualizado.getDocenteCodirectorId())
                .codirectorNombre(codirectorNombre)
                .estudiante1Id(actualizado.getEstudianteId())
                .estudiante1Nombre(estudiante1Nombre)
                .estudiante2Id(estudiante2Id)
                .estudiante2Nombre(estudiante2Nombre)
                .build();

        log.info("ðŸ“¤ Publicando evento FormatoAReenviado para proyecto: {} versiÃ³n: {}",
                actualizado.getId(), actualizado.getNumeroIntentos());
        progressEventPublisher.publicarFormatoAReenviado(event);
        log.info("âœ… Evento FormatoAReenviado publicado exitosamente");

        // 15. Obtener email del coordinador y enviar notificaciÃ³n (RF4)
        try {
            String coordinadorEmail = identityClient.getCoordinadorEmail();
            notificationPublisher.notificarFormatoAEnviado(
                    actualizado.getId().intValue(),
                    actualizado.getTitulo(),
                    actualizado.getNumeroIntentos(), // versiÃ³n 2 o 3
                    userInfo != null ? userInfo.getNombreCompleto() : "DESCONOCIDO",
                    coordinadorEmail
            );
            log.info("âœ‰ï¸ RF4: NotificaciÃ³n de reenvÃ­o (v{}) enviada al coordinador: {}",
                     actualizado.getNumeroIntentos(), coordinadorEmail);
        } catch (Exception e) {
            log.error("âŒ RF4: Error al enviar notificaciÃ³n, pero el Formato A fue reenviado exitosamente", e);
            // No fallar la operaciÃ³n principal por error en notificaciÃ³n
        }

        // 16. Retornar respuesta
        return new IdResponse(actualizado.getId());
    }

    @Override
    public void cambiarEstadoFormatoA(Long versionId, EvaluacionRequest req) {
        // TODO: Implementar lÃ³gica completa
        throw new UnsupportedOperationException("MÃ©todo cambiarEstadoFormatoA aÃºn no implementado");
    }

    @Override
    public IdResponse subirAnteproyecto(String userId, AnteproyectoData data, MultipartFile pdf) {
        log.info("ðŸ“„ Subiendo anteproyecto - Proyecto: {}, Usuario: {}", data.getProyectoId(), userId);

        // 1. Validar PDF obligatorio
        validarArchivoPdfObligatorio(pdf);

        // 2. Buscar proyecto en ProyectoGrado (NO ProyectoSubmission)
        ProyectoGrado proyecto = proyectoGradoRepository.findById(data.getProyectoId().intValue())
                .orElseThrow(() -> new ResponseStatusException(
                        HttpStatus.NOT_FOUND,
                        "Proyecto no existe"));

        log.info("ðŸ” Proyecto encontrado: ID={}, TÃ­tulo={}, Director={}",
                proyecto.getId(), proyecto.getTitulo(), proyecto.getDirectorId());

        // 3. Validar que el usuario es el DIRECTOR del proyecto
        if (proyecto.getDirectorId() == null) {
            log.error("âŒ El proyecto {} no tiene director asignado", proyecto.getId());
            throw new ResponseStatusException(HttpStatus.FORBIDDEN,
                    "El proyecto no tiene director asignado");
        }

        // Convertir userId a Integer para comparar correctamente
        Integer userIdInt = Integer.valueOf(userId);
        if (!proyecto.getDirectorId().equals(userIdInt)) {
            log.error("âŒ Usuario {} NO es el director del proyecto (director: {})", userId, proyecto.getDirectorId());
            throw new ResponseStatusException(HttpStatus.FORBIDDEN,
                    "Solo el director del proyecto puede subir el anteproyecto");
        }

        log.info("âœ… ValidaciÃ³n de director exitosa: Usuario {} es el director", userId);

        // 4. Validar que el Formato A estÃ¡ APROBADO
        if (proyecto.getEstado() != enumEstadoProyecto.APROBADO) {
            log.error("âŒ El Formato A del proyecto {} NO estÃ¡ aprobado (estado actual: {})",
                    proyecto.getId(), proyecto.getEstado());
            throw new ResponseStatusException(HttpStatus.CONFLICT,
                    "El Formato A debe estar aprobado antes de subir anteproyecto");
        }

        log.info("âœ… Formato A estÃ¡ aprobado, se puede subir anteproyecto");

        // 5. Validar que NO existe anteproyecto previo
        Optional<Anteproyecto> existente = anteproyectoRepository.findByProyecto(proyecto);
        if (existente.isPresent()) {
            log.error("âŒ Ya existe un anteproyecto para el proyecto {}", proyecto.getId());
            throw new ResponseStatusException(HttpStatus.CONFLICT,
                    "Ya existe un anteproyecto para este proyecto");
        }

        log.info("âœ… No hay anteproyecto previo, se procede a crear uno nuevo");

        // 6. Guardar archivo PDF en disco
        String baseDir = "anteproyectos/" + proyecto.getId();
        String pdfPath = guardarArchivo(baseDir, "documento.pdf", pdf);
        log.info("âœ… PDF guardado en: {}", pdfPath);

        // 7. Crear entidad Anteproyecto
        Anteproyecto anteproyecto = new Anteproyecto();
        anteproyecto.setProyecto(proyecto);
        anteproyecto.setRutaArchivo(pdfPath);
        anteproyecto.setNombreArchivo(pdf.getOriginalFilename() != null ?
                pdf.getOriginalFilename() : "documento.pdf");
        anteproyecto.setFechaEnvio(LocalDateTime.now());
        anteproyecto.setEstado("PENDIENTE");

        // 8. Guardar en BD
        anteproyectoRepository.save(anteproyecto);
        log.info("âœ… Anteproyecto guardado en BD para proyecto: {}", proyecto.getId());

        // 9. Obtener informaciÃ³n del usuario responsable (director)
        IdentityClient.UserBasicInfo userInfo = identityClient.getUserById(Long.valueOf(userId));
        log.info("âœ… Usuario responsable obtenido: {}", userInfo != null ? userInfo.getNombreCompleto() : "DESCONOCIDO");

        // 10. Obtener informaciÃ³n del director
        String directorNombre = "Director Desconocido";
        if (proyecto.getDirectorId() != null) {
            IdentityClient.UserBasicInfo directorInfo = identityClient.getUserById(proyecto.getDirectorId().longValue());
            directorNombre = directorInfo != null ? directorInfo.getNombreCompleto() : "Director Desconocido";
            log.info("âœ… Director obtenido: {}", directorNombre);
        }

        // 11. Obtener informaciÃ³n del codirector (si existe)
        String codirectorNombre = null;
        if (proyecto.getCodirectorId() != null) {
            IdentityClient.UserBasicInfo codirectorInfo = identityClient.getUserById(proyecto.getCodirectorId().longValue());
            codirectorNombre = codirectorInfo != null ? codirectorInfo.getNombreCompleto() : "Codirector Desconocido";
            log.info("âœ… Codirector obtenido: {}", codirectorNombre);
        }

        // 12. Obtener informaciÃ³n del estudiante 1 (y su programa)
        String estudiante1Nombre = "Estudiante Desconocido";
        String programa = "DESCONOCIDO";
        if (proyecto.getEstudiante1Id() != null) {
            IdentityClient.UserBasicInfo estudiante1Info = identityClient.getUserById(proyecto.getEstudiante1Id().longValue());
            estudiante1Nombre = estudiante1Info != null ? estudiante1Info.getNombreCompleto() : "Estudiante Desconocido";
            if (estudiante1Info != null && estudiante1Info.programa() != null) {
                programa = estudiante1Info.programa();
            }
            log.info("âœ… Estudiante 1 obtenido: {} - Programa: {}", estudiante1Nombre, programa);
        }

        // 13. Obtener informaciÃ³n del estudiante 2 (si existe)
        String estudiante2Nombre = null;
        if (proyecto.getEstudiante2Id() != null) {
            IdentityClient.UserBasicInfo estudiante2Info = identityClient.getUserById(proyecto.getEstudiante2Id().longValue());
            estudiante2Nombre = estudiante2Info != null ? estudiante2Info.getNombreCompleto() : "Estudiante 2 Desconocido";
            log.info("âœ… Estudiante 2 obtenido: {}", estudiante2Nombre);
        }

        // 14. Publicar evento a Progress Tracking con TODOS los campos
        AnteproyectoEnviadoEvent event = AnteproyectoEnviadoEvent.builder()
                .proyectoId(proyecto.getId().longValue())
                .titulo(proyecto.getTitulo())
                .modalidad(proyecto.getModalidad().name())
                .programa(programa)
                .descripcion("Anteproyecto completo enviado")
                .timestamp(LocalDateTime.now())
                .usuarioResponsableId(Long.valueOf(userId))
                .usuarioResponsableNombre(userInfo != null ? userInfo.getNombreCompleto() : "DESCONOCIDO")
                .usuarioResponsableRol("DOCENTE")
                // âœ¨ InformaciÃ³n completa del proyecto
                .directorId(proyecto.getDirectorId() != null ? proyecto.getDirectorId().longValue() : null)
                .directorNombre(directorNombre)
                .codirectorId(proyecto.getCodirectorId() != null ? proyecto.getCodirectorId().longValue() : null)
                .codirectorNombre(codirectorNombre)
                .estudiante1Id(proyecto.getEstudiante1Id() != null ? proyecto.getEstudiante1Id().longValue() : null)
                .estudiante1Nombre(estudiante1Nombre)
                .estudiante2Id(proyecto.getEstudiante2Id() != null ? proyecto.getEstudiante2Id().longValue() : null)
                .estudiante2Nombre(estudiante2Nombre)
                .build();

        log.info("ðŸ“¤ Publicando evento AnteproyectoEnviado para proyecto: {}", proyecto.getId());
        progressEventPublisher.publicarAnteproyectoEnviado(event);
        log.info("âœ… Evento AnteproyectoEnviado publicado exitosamente");

        // 15. Obtener email del jefe de departamento y enviar notificaciÃ³n (RF6)
        try {
            String jefeDepartamentoEmail = identityClient.getJefeDepartamentoEmail();
            notificationPublisher.notificarAnteproyectoEnviado(
                    proyecto.getId(),
                    proyecto.getTitulo(),
                    userInfo != null ? userInfo.getNombreCompleto() : "DESCONOCIDO",
                    jefeDepartamentoEmail
            );
            log.info("âœ‰ï¸ RF6: NotificaciÃ³n enviada al jefe de departamento: {}", jefeDepartamentoEmail);
        } catch (Exception e) {
            log.error("âŒ RF6: Error al enviar notificaciÃ³n, pero el Anteproyecto fue creado exitosamente", e);
            // No fallar la operaciÃ³n principal por error en notificaciÃ³n
        }

        // 16. Retornar respuesta con el ID del PROYECTO (no del anteproyecto)
        return new IdResponse(proyecto.getId().longValue());
    }

    /**
     * MÃ©todo auxiliar para validar que el archivo PDF es obligatorio
     */
    private void validarArchivoPdfObligatorio(MultipartFile pdf) {
        if (pdf == null || pdf.isEmpty()) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST,
                    "El archivo PDF es obligatorio");
        }

        String contentType = pdf.getContentType();
        if (contentType == null || !contentType.equals("application/pdf")) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST,
                    "El archivo debe ser un PDF");
        }
    }

    /**
     * MÃ©todo auxiliar para guardar archivos en disco
     */
    private String guardarArchivo(String baseDir, String nombreArchivo, MultipartFile file) {
        try {
            // Crear directorio base si no existe
            Path uploadPath = Paths.get("/app/uploads", baseDir);
            if (!Files.exists(uploadPath)) {
                Files.createDirectories(uploadPath);
            }

            // Guardar archivo
            Path filePath = uploadPath.resolve(nombreArchivo);
            Files.copy(file.getInputStream(), filePath, StandardCopyOption.REPLACE_EXISTING);

            return filePath.toString();
        } catch (IOException e) {
            log.error("âŒ Error al guardar archivo: {}", e.getMessage(), e);
            throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR,
                    "Error al guardar el archivo", e);
        }
    }

    @Override
    public AnteproyectoPage listarAnteproyectos(int page, int size) {
        // TODO: Implementar lÃ³gica completa
        throw new UnsupportedOperationException("MÃ©todo listarAnteproyectos aÃºn no implementado");
    }

    @Override
    public void cambiarEstadoAnteproyecto(Long id, CambioEstadoAnteproyectoRequest req) {
        // TODO: Implementar lÃ³gica completa
        throw new UnsupportedOperationException("MÃ©todo cambiarEstadoAnteproyecto aÃºn no implementado");
    }
}
